<!DOCTYPE html>
<html>
<head><title>Colyseus Diagnostic</title></head>
<body>
  <h1>Colyseus Loading Diagnostic</h1>
  <button onclick="runTest()">Run Test</button>
  <pre id="log" style="background:#f4f4f4;padding:10px;border:1px solid #ccc"></pre>

  <script>
    const logEl = document.getElementById('log');
    function log(msg) {
      logEl.textContent += msg + '\n';
      console.log(msg);
    }

    function runTest() {
      logEl.textContent = '';
      log('=== DIAGNOSTIC START ===\n');

      // Step 1: Check environment
      log('1. Environment Check:');
      log('   - typeof exports: ' + typeof exports);
      log('   - typeof module: ' + typeof module);
      log('   - typeof define: ' + typeof define);
      log('   - typeof window: ' + typeof window);
      log('   - typeof global: ' + typeof global);
      log('   - typeof globalThis: ' + typeof globalThis);
      log('');

      // Step 2: Load the script dynamically
      log('2. Loading Colyseus...');
      const script = document.createElement('script');
      script.src = '/js/lib/colyseus-vendored.js';

      script.onload = () => {
        log('   ✓ Script loaded\n');

        // Step 3: Check what was created
        log('3. Checking window.Colyseus:');
        log('   - typeof window.Colyseus: ' + typeof window.Colyseus);

        if (window.Colyseus) {
          log('   - Colyseus is: ' + (Array.isArray(window.Colyseus) ? 'Array' : typeof window.Colyseus));
          log('   - Keys: ' + Object.keys(window.Colyseus).join(', '));
          log('');

          log('4. Checking Colyseus.Client:');
          log('   - typeof Colyseus.Client: ' + typeof Colyseus.Client);

          if (Colyseus.Client) {
            log('   - Client.toString(): ' + Colyseus.Client.toString().substring(0, 100));
            log('   - Client.prototype: ' + (Colyseus.Client.prototype ? 'exists' : 'missing'));
            log('');

            // Step 5: Try to instantiate
            log('5. Attempting to create client:');
            try {
              const client = new Colyseus.Client('ws://localhost:2567');
              log('   ✓✓✓ SUCCESS! Client created');
              log('   - client type: ' + typeof client);
              log('   - client constructor: ' + client.constructor.name);
            } catch (e) {
              log('   ✗ FAILED: ' + e.message);
              log('   - Error type: ' + e.constructor.name);
              log('   - Stack: ' + e.stack.substring(0, 200));
            }
          } else {
            log('   ✗ Colyseus.Client is undefined/null');
          }
        } else {
          log('   ✗ window.Colyseus is undefined/null');
        }

        log('\n=== DIAGNOSTIC END ===');
      };

      script.onerror = (e) => {
        log('   ✗ Script failed to load: ' + e);
      };

      document.head.appendChild(script);
    }
  </script>
</body>
</html>
